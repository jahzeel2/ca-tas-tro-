@model GeoSit.Client.Web.Models.SeguridadModel
@using GeoSit.Client.Web.Controllers;

@{
    ViewBag.Title = "Administración de Perfiles";
    ViewBag.Description = "";
    ViewBag.CantidadMaxima = 100;
}

<link href="~/Content/dataTables.bootstrap.css" rel="stylesheet" />
<link href="~/Scripts/jstree/dist/themes/default/style.css" rel="stylesheet" />
<link href="~/Content/seguridad_new.css" rel="stylesheet" />

<div class="modal fade theme_new seguridad" id="modal-abm-perfiles" tabindex="-100" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div id="scroll-content-perfiles" class="scroll-content">
                <div class="modal-header">
                    <h3 class="modal-title">@ViewBag.Title</h3>
                    <span aria-hidden="true" class="fa fa-close fa-2x white cursor-pointer pull-right" data-dismiss="modal" aria-label="Cerrar" title="Cerrar"></span>
                </div>
                <div class="modal-body perfiles-body">
                    <div id="perfiles-content" class="body-content">
                        <div class="panel panel-group perfiles-listado">
                            <div class="panel-body">
                                <div class="form-group clearfix remove-margin">
                                    <div class="col-xs-12 remove-padding">
                                        <div class="tabla-con-botones">
                                            <table id="Grilla_Perfiles" class="table table-striped table-condensed table-bordered table-responsive"></table>
                                            <dl>
                                                @if (SeguridadController.ExisteFuncion(@Resources.Seguridad.AltaPerfil))
                                                {
                                                    <dt><span data-edita="nuevo" id="btnAgregar" class="fa fa-plus-circle fa-2x"></span></dt>
                                                }
                                                @if (SeguridadController.ExisteFuncion(@Resources.Seguridad.EliminarPerfil))
                                                {
                                                    <dt><span id="btnEliminar" class="fa fa-minus-circle fa-2x disabled"></span></dt>
                                                }
                                                @if (SeguridadController.ExisteFuncion(@Resources.Seguridad.ModificarPerfil))
                                                {
                                                    <dt><span data-edita="existente" id="btnEditar" class="fa fa-pencil fa-2x disabled"></span></dt>
                                                }
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-group accordion" id="accordion-perfiles">
                            <form role="form" id="form" action='@Url.Action("SetPerfiles_Save","Seguridad")' method="post">
                                <div class="accordion-section">
                                    <div class='panel-heading bg-primary main-heading panel-deshabilitado' role='region' id='headingDetallePerfil'>
                                        <a data-toggle='collapse' data-parent='#accordion-perfiles' href='#collapseDetallePerfil' aria-expanded='false'
                                           aria-controls='collapseDetallePerfil' class="collapsed">
                                            <div class='panel-title'>
                                                Detalle de Perfil
                                                <i class="fa"></i>
                                            </div>
                                        </a>
                                    </div>
                                    <div id='collapseDetallePerfil' class='panel-collapse collapse main-collapse' aria-expanded='false' aria-labelledby='headingDetallePerfil'>
                                        <div class="row remove-margin" style="margin-top:7px;">
                                            <div class="col-xs-12">
                                                <div class="form-inline">
                                                    <div class="form-group col-xs-12 remove-padding">
                                                        <div class="row remove-margin">
                                                            <div class="col-xs-6 remove-padding">
                                                                <label>* Nombre</label>
                                                            </div>
                                                            <div class="col-xs-6 remove-padding text-right">
                                                                <label><span id="lblNombreHorario">Seleccionar Horario</span>&nbsp;</label>
                                                                <span id="btn_Horarios" title="Seleccionar Horario" class="black boton-deshabilitado cursor-pointer">
                                                                    <i class="fa fa-lg fa-calendar" aria-hidden="true"></i>
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="row remove-margin">
                                                            <div class="col-xs-12 remove-padding">
                                                                <input type="text" maxlength="50" value="" style="width:100%;" class="form-control"
                                                                       id="txtPerfilNombre" name="Perfiles.Nombre" readonly required>

                                                                <input type="hidden" id="hfIdPerfil" name="Perfiles.Id_Perfil">
                                                                <input type="hidden" id="hfIdHorario" name="Perfiles.Id_Horario">
                                                                <input type="hidden" id="hfFechaModificacion" name="Perfiles.Fecha_Modificacion">
                                                                <input type="hidden" id="hfUsuariosPerfil">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-section">
                                    <div class='panel-heading bg-primary main-heading panel-deshabilitado' role='region' id='headingDetalleFunciones'>
                                        <a data-toggle='collapse' data-parent='#accordion-perfiles' href='#collapseDetalleFunciones' aria-expanded='false'
                                           aria-controls='collapseDetalleFunciones' class="collapsed">
                                            <div class='panel-title'>
                                                Funciones
                                                <i class="fa"></i>
                                            </div>
                                        </a>
                                    </div>
                                    <div id='collapseDetalleFunciones' class='panel-collapse collapse main-collapse' aria-expanded='false' aria-labelledby='headingDetalleFunciones'>
                                        <div class="row remove-margin" style="margin-top:7px;">
                                            <div class="col-xs-7">
                                                <label for="Filtrar_Funciones">Filtrar</label>
                                                <div class="input-group">
                                                    <input type="text" value="" class="form-control" id="Filtrar_Funciones" readonly name="Filtrar_Funciones">
                                                    <span id="clearSearchFunciones" class="input-group-addon cursor-pointer">
                                                        <i class="fa fa-lg fa-eraser" aria-hidden="true"></i>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row remove-margin" style="margin-top:7px;">
                                            <div class="col-xs-12">
                                                <div class="form-control jstree-border" readonly>
                                                    <div id="divtreeFunciones" role="tree"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-section">
                                    <div class='panel-heading bg-primary main-heading panel-deshabilitado' role='region' id='headingDetalleComponentes'>
                                        <a data-toggle='collapse' data-parent='#accordion-perfiles' href='#collapseDetalleComponentes' aria-expanded='false'
                                           aria-controls='collapseDetalleComponentes' class="collapsed">
                                            <div class='panel-title'>
                                                Componentes
                                                <i class="fa"></i>
                                            </div>
                                        </a>
                                    </div>
                                    <div id='collapseDetalleComponentes' class='panel-collapse collapse main-collapse' aria-expanded='false' aria-labelledby='headingDetalleComponentes'>
                                        <div class="row remove-margin" style="margin-top:7px;display:block;">
                                            <div class="col-xs-7">
                                                <label for="Filtrar_Componentes">Filtrar</label>
                                                <div class="input-group">
                                                    <input type="text" value="" class="form-control" id="Filtrar_Componentes" readonly name="Filtrar_Componentes">
                                                    <span id="clearSearchComponentes" class="input-group-addon cursor-pointer">
                                                        <i class="fa fa-lg fa-eraser" aria-hidden="true"></i>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row remove-margin" style="margin-top:7px;">
                                            <div class="col-xs-12">
                                                <div class="form-control jstree-border" readonly>
                                                    <div id="divtreeComponentes" role="tree"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="col-lg-4 pull-right">
                    <span id="btnGuardar" aria-hidden="true" data-placement="right" title="Guardar" data-original-title="Guardar" class="fa fa-floppy-o fa-2x black boton-deshabilitado cursor-pointer"></span>
                    <span id="btnDescartar" aria-hidden="true" data-placement="right" title="Cancelar" data-original-title="Cancelar" class="fa fa-undo fa-2x black boton-deshabilitado cursor-pointer"></span>
                </div>
            </div>
        </div>
    </div>
</div>
@*
    <!-- Modal Advertencia-->
    <div class="modal fade theme_new mensaje" id="ModalAdvertenciaPerfiles" tabindex="-2" role="dialog" aria-labelledby="TituloAdvertencia" aria-hidden="true" data-backdrop="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="TituloAdvertencia">Titulo</h3>
                    <span aria-hidden="true" class="fa fa-close fa-2x white cursor-pointer pull-right" data-dismiss="modal" aria-label="Cerrar" title="Cerrar"></span>
                </div>
                <div class="modal-body">
                    <div id="MensajeAlerta" class="alert alert-warning alert-dismissible" role="alert">
                        <strong>Atención!</strong><br />
                        <p id="DescripcionAdvertencia">Está a punto de DESACTIVAR al usuario Perez, Juan <br />Está seguro de continuar?</p>
                    </div>
                </div>
                <div class="modal-footer hidden">
                    <div class="col-lg-4 pull-right">
                        <span id="btnAdvertenciaOK" aria-hidden="true" data-dismiss="modal" data-placement="right" title="Seleccionar" data-original-title="Seleccionar" class="fa fa-check-circle fa-3x light-blue cursor-pointer"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
*@
<!-- Modal Información-->
<div class="modal fade theme_new mensaje" id="ModalInfoPerfiles" tabindex="-3" role="dialog" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="TituloInfo">Titulo</h3>
                <span aria-hidden="true" class="fa fa-close fa-2x white cursor-pointer pull-right" data-dismiss="modal" aria-label="Cerrar" title="Cerrar"></span>
            </div>
            <div class="modal-body">
                <div class="alert alert-success alert-dismissible" role="alert">
                    <p id="DescripcionInfo">Descripcion de la informacion</p>
                </div>
            </div>
            <div class="modal-footer" style="display:none;">
                <div class="col-lg-4 pull-right">
                    <span id="btnInfoOK" aria-hidden="true" data-dismiss="modal" title="Seleccionar" class="fa fa-check-circle fa-3x light-blue cursor-pointer"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal HORARIOS-->
<div class="modal fade theme_new seguridad" id="ModalHorarios" tabindex="-3" role="dialog" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="scroll-content">
                <div class="modal-header">
                    <h3 class="modal-title">Seleccione un Horario</h3>
                    <span aria-hidden="true" class="fa fa-close fa-2x white cursor-pointer pull-right" data-dismiss="modal" aria-label="Cerrar" title="Cerrar"></span>
                </div>
                <div class="modal-body seleccion-horario-body">
                    <div id="seleccion-horario-content" class="body-content">
                        <div class="panel panel-group horarios-listado" style="box-shadow:none;margin: 0;">
                            <div class="panel-body">
                                <div class="form-group clearfix remove-margin">
                                    <div class="col-xs-12 remove-padding">
                                        <table id="Grilla_Horarios" class="table table-striped table-condensed table-bordered table-responsive"></table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="col-lg-4 pull-right">
                        <span id="btnHorariosOK" aria-hidden="true" data-dismiss="modal" data-placement="right" title="Seleccionar" data-original-title="Seleccionar" class="fa fa-check-circle fa-2x black cursor-pointer"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal USUARIOS ASOCIADOS -->
<div class="modal fade theme_new seguridad" id="ModalUsuariosAsociados" tabindex="-3" role="dialog" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="scroll-content">
                <div class="modal-header">
                    <h3 class="modal-title">Usuarios Asociados</h3>
                    <span aria-hidden="true" class="fa fa-close fa-2x white cursor-pointer pull-right" data-dismiss="modal" aria-label="Cerrar" title="Cerrar"></span>
                </div>
                <div class="modal-body seleccion-horario-body">
                    <div id="seleccion-horario-content" class="body-content">
                        <div class="panel panel-group usuarios" style="box-shadow:none;margin: 0;">
                            <div class="panel-body" style="padding-top: 0;padding-bottom: 0;">
                                <div class="form-group clearfix remove-margin">
                                    <div class="alert alert-info alert-dismissible" role="alert">
                                        <p id="DescripcionInfo">
                                            El perfil que intenta eliminar se encuentra asignado a los siguientes Usuarios.
                                            <br />
                                            Para poder ser eliminado, el perfil no debe estar asignado a ninguno.
                                        </p>
                                    </div>
                                    <div class="col-xs-12 remove-padding">
                                        <table id="Grilla_Usuarios" class="table table-striped table-condensed table-bordered table-responsive"></table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/Scripts/jquery.dataTables.min.js"></script>
<script src="~/Scripts/dataTables.bootstrap.js"></script>
<script src="~/Scripts/jstree/dist/jstree.js"></script>
<script src="~/Scripts/jquery.form.js"></script>
<script>
    $(window).resize(ajustamodal);
    $(document).ready(init);

    function init() {
        $('#modal-abm-perfiles').one('shown.bs.modal', function () {
            @if (!string.IsNullOrEmpty(ViewBag.MensajeSalida))
            {
                string titulo = "Nuevo Perfil";
                var mensaje = "Los datos del perfil han sido guardados satisfactoriamente.";
                if (ViewBag.MensajeSalida == "ModificacionOK")
                {
                    titulo = "Modificación de Perfil";
                }
                else if (ViewBag.MensajeSalida == "EliminacionOK")
                {
                    titulo = "Eliminación de Perfil";
                    mensaje = "El perfil ha sido eliminado correctamente.";
                }
            <text>
            mostrarMensajeGeneral(['@mensaje'], '@titulo', false);
            </text>
            }
            changeTreeStatus('divtreeFunciones', "root", true);
            changeTreeStatus('divtreeComponentes', "root", true);
            ajustamodal();
            hideLoading();
        });
        $("#perfiles-content").niceScroll(getNiceScrollConfig());
        $('#scroll-content-perfiles .panel-body').resize(ajustarScrollBarsPerfiles);
        $('#perfiles-content .panel-heading a').click(function () {
            setTimeout(ajustarScrollBarsPerfiles, 10);
        });

        $.ajax({
            url: '@Url.Action("GetPerfilesJson", "Seguridad")',
            dataType: 'json',
            type: 'GET',
            success: function (perfiles) {
                $("#Grilla_Perfiles").DataTable({
                    dom: "<'row'<'col-sm-12'f>>tr<'row'<'col-sm-12'p>>",
                    destroy: true,
                    language: {
                        url: BASE_URL + "Scripts/dataTables.spanish.txt"
                    },
                    order: [0, 'asc'],
                    data: perfiles,
                    columns: [{ title: "Perfiles", data: "Nombre", orderable: true, visible: true }],
                    createdRow: function (row, data) {
                        $(row).data('id', data.Id_Perfil);
                        $(row).addClass('cursor-pointer');
                    },
                    initComplete: function (options) {
                        $(this).dataTable().api().columns.adjust();
                        $(options.nTBody).off("click", "tr");
                        $(options.nTBody).on("click", "tr", function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            $(this).siblings().removeClass('selected');
                            $(this).toggleClass('selected');
                            getDatos(this);
                        });
                    }
                });
            },
            error: function (error) {
                mostrarMensajeError([error.responseText], "Recuperar Perfiles", true);
            }
        });
        initTree('divtreeFunciones',@Html.Raw(Json.Encode(@ViewBag.ArbolFunciones.ToArray())));
        initTree('divtreeComponentes',@Html.Raw(Json.Encode(@ViewBag.ArbolComponentes.ToArray())));

        $('#btnAgregar').on('click', function () {
            fillDatosPerfil();
            seleccionarArbol("#divtreeFunciones", []);
            seleccionarArbol("#divtreeComponentes", []);
            iniciarEdicion("nuevo");
        });
        $('#btnEditar').on('click', iniciarEdicion);
        $('#btnEliminar').on('click', function () {
            var msjs = [], mostrar = mostrarMensajeError;
            $('#btnInfoOK').off('click');
            if (parseInt($("#hfUsuariosPerfil", "#modal-abm-perfiles").val()) === 0) {
                $('#btnInfoOK').one('click', eliminarPerfil);
                msjs.push("Está a punto de ELIMINAR el perfil " + $('#txtPerfilNombre').val() + ".");
                msjs.push("¿Desea Continuar?");
                mostrar = mostrarMensajeGeneral;
                mostrar(msjs, "Eliminar", true);
            } else {
                showLoading();
                $.ajax({
                    method: 'GET',
                    url: '@Url.Action("GetUsuariosPerfil", "Seguridad")/' + $('#hfIdPerfil').val() ,
                    success: function (usuarios) {
                        $("#Grilla_Usuarios").DataTable({
                            dom: "ftrp",
                            destroy: true,
                            language: { url: BASE_URL + "Scripts/dataTables.spanish.txt" },
                            order: [0, 'asc'],
                            data: usuarios,
                            columns: [
                                { title: "Usuario", data: "Login", orderable: true },
                                { title: "Nombre", data: "Nombre", orderable: true },
                                { title: "Apellido", data: "Apellido", orderable: true }
                            ]
                        });
                        $('#ModalUsuariosAsociados').modal('show');
                    },
                    error: function (error) {

                    },
                    complete: hideLoading
                });
            }
        });

        $('#btnDescartar').on('click', function () {
            $('#btnInfoOK').one('click', finalizarEdicion);
            mostrarMensajeGeneral(["Está a punto de CANCELAR la operación.", "Los datos ingresados/modificados serán eliminados.", "¿Desea continuar?"], "Cancelar", true);
        });
        $("#btnGuardar").on('click',function () {
            //VALIDA PERFIL
            if (!$('#txtPerfilNombre').val()) {
                mostrarMensajeError(["Debe ingresar un NOMBRE para el perfil."], "Sin Nombre");
                return false;
            }

            //VALIDA HORARIO
            if (parseInt('@ViewBag.TrabajaConHorarios') === 1) {
                if (!parseInt($('#hfIdHorario').val())) {
                    mostrarMensajeError(["Debe seleccionar un HORARIO para el perfil."], "Sin Horario");
                    return false;
                }
            } else {
                $('#hfIdHorario').val("1");
            }

            //VALIDA FUNCIONES
            $("[name='FuncionAsociada']").remove();
            $.each($('#divtreeFunciones').jstree("get_selected", true), function (_, func) {
                if (!isNaN(func.id)) {
                    $('#form').append("<input type='hidden' name='FuncionAsociada' value='" + func.id + "'>");
                }
            });
            $.each($("#divtreeFunciones").find(".jstree-undetermined"), function (_, elem) {
                var id = $(elem).closest('.jstree-node').attr("id");
                if (!isNaN(id)) {
                    $('#form').append("<input type='hidden' name='FuncionAsociada' value='" + id + "'>");
                }
            });
            if (!$("[name='FuncionAsociada']").length) {
                mostrarMensajeError(["Debe activar al menos una FUNCION para el perfil."], "Sin Funciones");
                return false;
            }

            //VALIDA COMPONENTES
            $("[name='ComponenteAsociado']").remove();
            $.each($('#divtreeComponentes').jstree("get_selected", true), function (_, cmp) {
                if (!isNaN(cmp.id)) {
                    $('#form').append("<input type='hidden' name='ComponenteAsociado' value='" + cmp.id + "'>");
                }
            });
            if (!$("[name='ComponenteAsociado']").length) {
                mostrarMensajeError(["Debe activar al menos un COMPONENTE para el perfil."], "Sin Componentes");
                return false;
            }

            //VALIDA PERFIL EXISTENTE
            verificaNombrePerfilExistente()
                .then(function (respuesta) {
                    if (respuesta !== 0 && respuesta !== parseInt($('#hfIdPerfil').val())) {
                        mostrarMensajeError(["El nombre del perfil ingresado ya se encuentra cargado."], "Nombre Existente");
                        return ;
                    }
                    $("#form").submit();
                })
                .catch(function (error) {
                    mostrarMensajeError([error.responseText], "Recuperar Perfil", true);
                });
        });

        $("#form").ajaxForm({
            beforeSubmit: function () {
                showLoading();
                return true; //it will continue your submission.
            },
            success: function (data) {
                $("#modal-abm-perfiles").modal('hide');
                setTimeout(function () {
                    $("#contenido").empty();
                    $("#contenido").html(data);
                }, 500);
            },
            error: function () {
                hideLoading();
                mostrarMensajeError(["Ha ocurrido un error al guardar los datos del perfil."], "Grabación de Perfil", true);
            }
        });
        $("#clearSearchFunciones").on('click', function () {
            $('#Filtrar_Funciones').val("").keyup();
        });
        $("#clearSearchComponentes").on('click', function () {
            $('#Filtrar_Componentes').val("").keyup();
        });
        $('#Filtrar_Funciones').on('input keyup', filtrarArbol);
        $('#Filtrar_Componentes').on('input keyup', filtrarArbol);
        $('#modal-abm-perfiles').modal('show');
    }

    function ajustamodal() {
        var altura = $(window).height() - 150; //value corresponding to the modal heading + footer
        $(".perfiles-body").css({ "height": altura, "overflow-y": "auto" });
        ajustarScrollBarsPerfiles();
    }
    function ajustarScrollBarsPerfiles() {
        $('#perfiles-content').css({ "max-height": $(".perfiles-body").height() + 'px',  "height": "100%" });
        $('#perfiles-content').getNiceScroll().resize();
    }
    function activarSecciones(row, forzar) {
        var secciones = $(".panel-heading[role='region']", '#accordion-perfiles');
        if (forzar || (row && row.hasClass('selected'))) {
            secciones.removeClass("panel-deshabilitado");
            secciones.each(function (_, seccion) {
                $("a[data-toggle]", seccion).removeClass("collapsed");
                $("[aria-labelledby='" + $(seccion).attr("id") + "']").addClass("in").attr("aria-expanded", true).css('height','auto');
            });
            $("dl .fa:not(:first)", ".perfiles-listado").removeClass("disabled");
        } else {
            secciones.addClass("panel-deshabilitado");
            secciones.each(function (_, seccion) {
                //$("a[data-toggle]:not(.collapsed)", seccion).click();
                $("a[data-toggle]", seccion).addClass("collapsed");
                $("[aria-labelledby='" + $(seccion).attr("id") + "']").removeClass("in").attr("aria-expanded", false).css('height','0');
            });
            $("dl .fa:not(:first)", ".perfiles-listado").addClass("disabled");
            row = null;
        }
        ajustarScrollBarsPerfiles();
    }
    function iniciarEdicion(tipo) {
        if (tipo === "nuevo") {
            $("#Grilla_Perfiles > tbody > tr").removeClass("selected");
            activarSecciones(null, true);
        }
        $("#Grilla_Perfiles", ".perfiles-listado").attr("disabled", "disabled");
        $("form .form-control",'#modal-abm-perfiles').removeAttr("readonly");
        $("dl .fa", ".perfiles-listado").addClass("disabled");
        changeTreeStatus('divtreeFunciones', "root", false);
        changeTreeStatus('divtreeComponentes', "root", false);
        $("#btn_Horarios").removeClass('boton-deshabilitado');
        $('.modal-footer span', '#modal-abm-perfiles').removeClass('boton-deshabilitado');

        $('#btn_Horarios').on('click', seleccionarHorario);
    }
    function finalizarEdicion() {
        $("#Grilla_Perfiles", ".perfiles-listado").removeAttr("disabled");
        $("form .form-control",'#modal-abm-perfiles').attr("readonly","readonly");
        $("dl .fa", ".perfiles-listado").removeClass("disabled");
        changeTreeStatus('divtreeFunciones', "root", true);
        changeTreeStatus('divtreeComponentes', "root", true);
        $("#btn_Horarios").addClass('boton-deshabilitado');
        $('.modal-footer span', '#modal-abm-perfiles').addClass('boton-deshabilitado');
        getDatos($('tr.selected','#Grilla_Perfiles'));

    }

    function getDatos(row) {
        if (!$(row).hasClass('selected')) {
            activarSecciones();
            return;
        }
        showLoading();
        var cargas = []
            idPerfil = getIdPerfilSeleccionado(row);
        cargas.push(getDetallePerfilSeleccionado(idPerfil));
        cargas.push(getUsuariosPerfilSeleccionado(idPerfil));
        cargas.push(getFuncionesPerfilSeleccionado(idPerfil));
        cargas.push(getComponentesPerfilSeleccionado(idPerfil));

        Promise
            .all(cargas)
            .then(function (datos) {
                fillDatosPerfil(datos[0],datos[1]);
                seleccionarArbol("#divtreeFunciones", datos[2]);
                seleccionarArbol("#divtreeComponentes", datos[3]);
                activarSecciones($(row));
            })
            .catch(function (error) {
                mostrarMensajeError([error.responseText], "Recuperar Perfil", true);
            })
            .finally(hideLoading);
    }
    function getIdPerfilSeleccionado(row) {
        return $(row).data('id');
    }
    function getDetallePerfilSeleccionado(idPerfil) {
        return new Promise(function (resolve, reject) {
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetDatosPerfil")',
                dataType: 'json',
                data: { id: idPerfil },
                success: resolve,
                error: reject
            });
        });
    }
    function getUsuariosPerfilSeleccionado(idPerfil) {
        return new Promise(function (resolve, reject) {
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetUsuariosPerfil")',
                dataType: 'json',
                data: { id: idPerfil },
                success: resolve,
                error: reject
            });
        });
    }
    function getFuncionesPerfilSeleccionado(idPerfil) {
        return new Promise(function (resolve, reject) {
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetFuncionesPerfil")',
                dataType: 'json',
                data: { id: idPerfil },
                success: resolve,
                error: reject
            });
        });
    }
    function getComponentesPerfilSeleccionado(idPerfil) {
        return new Promise(function (resolve, reject) {
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetComponentesPerfil")',
                dataType: 'json',
                data: { id: idPerfil },
                success: resolve,
                error: reject
            });
        });
    }

    function fillDatosPerfil(perfil, usuarios) {
        perfil = perfil || {};
        $("#txtPerfilNombre","#modal-abm-perfiles").val(perfil.Nombre);
        $("#hfIdPerfil","#modal-abm-perfiles").val(perfil.Id_Perfil);
        $("#hfFechaModificacion", "#modal-abm-perfiles").val(perfil.Fecha_Modificacion);
        fillDatosHorario(perfil.Horario || {});
        fillDatosUsuarios(usuarios || []);
    }
    function fillDatosHorario(horario) {
        $("#hfIdHorario", "#modal-abm-perfiles").val(horario.Id_Horario || 0);
        $("#lblNombreHorario", "#modal-abm-perfiles").html(horario.Descripcion || 'Sin Horario');
    }
    function fillDatosUsuarios(usuarios) {
        $("#hfUsuariosPerfil", "#modal-abm-perfiles").val(usuarios.length);
    }
    function eliminarPerfil() {
        showLoading();
        $.ajax({
            type: 'POST',
            url: '@Url.Action("SetPerfiles_Delete")',
            data: {id:getIdPerfilSeleccionado($('tr.selected','#Grilla_Perfiles'))},
            dataType: 'html',
            success: function (data) {
                $("#modal-abm-perfiles").modal('hide');
                setTimeout(function () {
                    $("#contenido").empty();
                    $("#contenido").html(data);
                }, 500);
            },
            error: function () {
                hideLoading();
                mostrarMensajeError(["Ha ocurrido un error al eliminar el perfil."], "Eliminación de Perfil", true);
            }
        });
    }
    function seleccionarHorario() {
        var actual = parseInt($("#hfIdHorario").val());
        $("#Grilla_Horarios").DataTable({
            dom: "t",
            destroy: true,
            language: {
                url: BASE_URL + "Scripts/dataTables.spanish.txt"
            },
            order: [0, 'asc'],
            data: JSON.parse(@Html.Raw(Json.Encode(ViewBag.listaHorarios))),
            columns: [{ title: "Horarios", data: "Descripcion", orderable: true, visible: true }],
            createdRow: function (row, data) {
                $(row).data('id', data.Id_Horario);
                $(row).addClass('cursor-pointer');
                if (actual === data.Id_Horario) {
                    $(row).addClass('selected');
                }
            },
            initComplete: function (options) {
                $(this).dataTable().api().columns.adjust();
                $(options.nTBody).off("click", "tr");
                $(options.nTBody).on("click", "tr", function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    $(this).siblings().removeClass('selected');
                    $(this).toggleClass('selected');
                });
            }
        });
        $("#btnHorariosOK").one('click', function () {
            var nuevo = $("#Grilla_Horarios").dataTable().api().row(".selected").data();
            $("#lblNombreHorario").html(nuevo.Descripcion);
            $("#hfIdHorario").val(nuevo.Id_Horario);
        });
        $('#ModalHorarios').one('shown.bs.modal', function () {
            $("#Grilla_Horarios").dataTable().api().columns.adjust();
        });
        $('#ModalHorarios').modal('show');
    }
    function filtrarArbol(evt) {
        $('[role="tree"]', $(evt.currentTarget).parents('.collapse')).jstree(true).search($(evt.target).val().toLowerCase());
        return false;
    }
    function seleccionarArbol(tree, seleccion) {
        $(tree).jstree(true).deselect_all();
        $(tree).jstree(true).select_node(seleccion, true)
    }

    function flatHierarchy(nodo, hierarchy) {
        var parent = "root";
        if(!nodo.esRoot) parent = nodo.padre;
        hierarchy.push({ "id": nodo.id, "parent": parent, "text": nodo.nombre });
        if(nodo.hijos && nodo.hijos.length){
            $.each(nodo.hijos, function(_, hijo){ flatHierarchy(hijo, hierarchy); });
        }
    }
    function initTree(tree, hierarchy) {
        var data = [{ "id": "root", "parent": "#", "text": "Todos", "state": { "selected": false, "opened": true } }];
        $.each(hierarchy, function (_, nodo) { flatHierarchy(nodo, data); });

        $('#' + tree)
            .jstree({
                "core": {
                    "multiple": true,
                    "animation": 0,
                    "themes": { "icons": false },
                    "expand_selected_onload": false,
                    "data": data
                },
                "checkbox": {
                    "three_state": true,
                    "whole_node": true
                },
                "search": { //para filtros
                    "show_only_matches": true,
                    "show_only_matches_children": true
                },
                "plugins": ["checkbox", "search", "types"]
            });
    }
    function changeTreeStatus(tree, id, readonly) {
        var node = $('#' + tree).jstree().get_node(id);
        if (readonly) {
            $('#' + tree).jstree().disable_node(node);
        } else {
            $('#' + tree).jstree().enable_node(node);
        }
        node.children.forEach(function (child_id) {
            changeTreeStatus(tree, child_id, readonly);
        });
    }
    function verificaNombrePerfilExistente() {
        return new Promise(function (resolve, reject) {
            $.ajax({
                cache: false,
                url: '@Url.Action("GetPerfilByName", "Seguridad")',
                data: { id: $('#txtPerfilNombre').val() },
                type: 'GET',
                success: resolve,
                error: reject
            });
        });
    }
    function mostrarMensajeError(mensajes, titulo, error) {
        mostrarMensaje(mensajes, titulo, (error || false ? "alert-danger" : "alert-warning"));
    }
    function mostrarMensajeGeneral(mensajes, titulo, confirmacion) {
        mostrarMensaje(mensajes, titulo, (!!confirmacion ? "alert-info" : "alert-success"));
    }
    function mostrarMensaje(mensajes, titulo, tipo) {
        $('#TituloInfo','#ModalInfoPerfiles').html(titulo);
        $('#DescripcionInfo','#ModalInfoPerfiles').html(mensajes.join("<br />"));
        $("[role='alert']", "#ModalInfoPerfiles").removeClass("alert-danger alert-success alert-info alert-warning").addClass(tipo);
        $(".modal-footer", "#ModalInfoPerfiles").hide();
        if (tipo === "alert-info") {
            $(".modal-footer", "#ModalInfoPerfiles").show();
        }
        $("#ModalInfoPerfiles").modal('show');
        $("#ModalInfoPerfiles").one("hidden.bs.modal", function () { $("#btnInfoOK").off(); });
    }
</script>
